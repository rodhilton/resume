<% load 'lib/common.rb' %>

<%
  # Convert embedded HTML links to Typst link syntax:
  # <a href="URL">TEXT</a>  =>  link("URL")[TEXT]
  def latex_links(one)
    one.gsub(/<a href=(["'])(.*?)\1>(.*?)<\/a>/, '\#link("\\2")[\\3]')
  end

  def typst_links(one)
    one.gsub(/<a href=(["'])(.*?)\1>(.*?)<\/a>/, '#link("\\2")[\\3]')
  end

  # Strip <a> wrappers entirely, keep visible text
  def strip_links(one)
    one.gsub(/<a href=(["'])(.*?)\1>(.*?)<\/a>/, '\\3')
  end

  # Helpers to avoid "no text within underscores" warnings
  # Use for fields that are rendered as `info: [...]` where the content is typically italic.
  def typst_info(val)
    s = "#{val}".strip
    s.empty? ? 'none' : %|[_#{s}_]|
  end

  # Use for `info-top-left:` / `info-top-right:` where empty should be `none`, otherwise "text".
  def typst_info_text(val)
    s = (val || "").strip
    s.empty? ? 'none' : %|"#{s}"|
  end

  # Build skills map
  skill_weights = calculate_skill_weights(
    experience.jobs + education.degrees + projects + publications, 0.1, 0.08, 12
  )
  skills_grouped = group_by_category(skill_weights, skills_index, 8)

  # Choose recent jobs vs older
  job_list = flags[:complete_history] ? experience.jobs : trim_jobs(experience.jobs, 17)
  recent_jobs = job_list.first(5)
  older_jobs  = (experience.jobs - recent_jobs)

  def job_location(job)
    (job.environment == "Remote" || job.environment == "Hybrid") ? "Remote" : job.location
  end
%>

#import "@preview/lavandula:0.1.1": *

#show: lavandula-theme.with(
  custom-colors: (
    primary: rgb("#4786b2"),
    secondary: rgb("#dae7f0")
  )
)

#set text(lang: "en")
#set page(width: 8.5in, height: 11in)

#set document(
  title: "Rod Hilton (CV)",
  author: "Rod Hilton",
  date: none,
)

#cv(
  sidebar-position: "left",
  sidebar: [
    = Rod Hilton
    #grid(
      columns: (auto, 1fr),
      column-gutter: 8pt,
      align: (center, left),
      [
        #image("profile_circle.png", width: 15mm)
      ],
      [
        ==== <%= title %>
      ],
    )

    #contact-list((
      <% if flags[:email] %>(icon: "at", icon-solid: true, text: link("mailto:<%= flags[:email] %>")[<%= flags[:email].gsub("@","\\@") %>]),<% end %>
      (icon: "globe", icon-solid: true, text: link("https://www.rodhilton.com")[rodhilton.com]),
      (icon: "github", text: link("https://github.com/rodhilton")[github.com/rodhilton]),
      (icon: "linkedin", text: link("https://linkedin.com/in/rodhilton")[linkedin.com/in/rodhilton]),
      <% if flags[:phone] %>(icon: "phone", text: "<%= flags[:phone] %>"),<% end %>
      <% if flags[:socials] %>
        (icon: "mastodon", text: "mastodon.social/@rodhilton"),
        (icon: "bluesky", text: "bsky.app/profile/rodhilton.com"),
      <% end %>
    ))

    #sidebar-section(title: "Summary")[
      #set par(justify: true)
      #show par: it => block(width: 100%, it)

      <%= oneline_summary.nil? || strip_links(oneline_summary) %>
    ]

    #sidebar-section(title: "Technical skills")[
      <% skills_grouped.each do |category, skills| %>
      #skill-group(
        name: "<%= category %>",
        icon: "<%= category_to_icon(category, skills_index) %>",
        icon-solid: true,
        skills: (
          <% skills.each_with_index do |s, idx| %>
          "<%= s %>"<%= idx < skills.length - 1 ? "," : "" %>
          <% end %>
        )
      )
      <% end %>
    ]
  ],

  main-content: [
    == Experience
    <% recent_jobs.each_with_index do |job, i| %>
      <%
        accomplishments = trim_accomplishments(job.accomplishments, i, 2, 2)
      %>

      #section-element(
        title: [
          <%= strip_links(job.title.to_s) %>
          #h(2pt)#text(size: sizes.text-s3)[#fa-icon("at", solid: true)]#h(2pt)
          <%= strip_links(job.company.to_s) %>
        ],
        info: <%= typst_info(timespan(job.start_time, job.end_time)) %>,
        [
          #set text(size: sizes.text-s2)
          #icon-list((
            <% accomplishments.each do |acc| %>
            (icon: "angle-right", text: [<%= typst_links(acc) %>]),
            <% end %>
          ))
        ],
      )
      <% end %>

      <% if older_jobs.any? %>
      === Other Positions
      #set par(leading: 0.95em)
      #stack(spacing: 0pt,
        <% older_jobs.each_with_index do |job, idx| %>
        [#section-element(
          title: [
          <%= strip_links(job.title.to_s) %>
          #h(2pt)#text(size: sizes.text-s3)[#fa-icon("at", solid: true)]#h(2pt)
          <%= strip_links(job.company.to_s) %>
          ],
          info: <%= typst_info(timespan(job.start_time, job.end_time)) %>,
          [],
        )]<%= idx < older_jobs.length - 1 ? "," : "" %>
        <% end %>
      )
      <% end %>

      == Education
      <% education.degrees.each do |degree| %>
      #section-element(
        title: [
          <%= degree.title.to_s %>
          #h(2pt)#text(size: sizes.text-s3)[#fa-icon("at", solid: true)]#h(2pt)
          <%= degree.school.to_s %>
        ],
        info: <%= typst_info(extract_year(degree.end_time)) %>,
        [
          #set text(size: sizes.text-s2)
          #icon-list((
            <% if degree.note && !degree.note.empty? %>
            (icon: "angle-right", text: [<%= latex_links(degree.note) %>]),
            <% end %>
            (icon: "angle-right", text: [Coursework: <%= typst_links(degree.coursework) %>]),
          ))
        ],
      )
      <% end %>
  ],
)
